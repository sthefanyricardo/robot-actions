name: E2E Tests
run-name: Testes de CI com Robot Framework - ${{ github.event.head_commit.message }}

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      browser:
        description: "Navegador para executar os testes"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - chromium
          - firefox
          - edge

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22"

jobs:
  tests:
    strategy:
      matrix:
        browser: [chromium, firefox, edge]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Initialize Browser
        run: |
          rfbrowser init
        env:
          BROWSER: ${{ matrix.browser }}

      - name: Install Microsoft Edge
        if: matrix.browser == 'edge'
        run: |
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable

      - name: Create results directory
        run: mkdir -p ./tests-results-CI/${{ matrix.browser }}

      - name: Run E2E Tests
        run: |
          echo "Executando testes para o navegador: ${{ matrix.browser }}"
          echo "Diretório de trabalho: $(pwd)"
          echo "Conteúdo do diretório tests:"
          ls -la tests/ || echo "Diretório tests não encontrado"

          # Ajustar browser e channel
          if [ "${{ matrix.browser }}" = "edge" ]; then
            BROWSER=chromium
            CHANNEL=msedge
          else
            BROWSER=${{ matrix.browser }}
            CHANNEL="stable"
          fi

          robot \
            --name "Tests no navegador: ${{ matrix.browser }}" \
            --outputdir ./tests-results-CI/${{ matrix.browser }} \
            --variable BROWSER:$BROWSER \
            --variable CHANNEL:$CHANNEL \
            --variable HEADLESS:true \
            --variable TIMEOUT:30 \
            --loglevel INFO \
            --include smoke \
            tests/
        continue-on-error: true
        env:
          PLAYWRIGHT_LOG_FILENAME: ${{ matrix.browser }}-playwright-log.txt

      - name: Check Test Results
        if: always()
        run: |
          echo "Verificando resultados dos testes..."
          if [ -f "./tests-results-CI/${{ matrix.browser }}/output.xml" ]; then
            echo "Arquivo output.xml encontrado!"
            ls -la "./tests-results-CI/${{ matrix.browser }}/"
          else
            echo "Arquivo output.xml não encontrado."
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}
          path: tests-results-CI/${{ matrix.browser }}/
          retention-days: 30

      - name: Robot Framework Reporter
        uses: joonvena/robotframework-reporter-action@v2.5
        if: always()
        with:
          gh_access_token: ${{ secrets.GITHUB_TOKEN }}
          report_path: tests-results-CI/${{ matrix.browser }}

  # Job para consolidar resultados e publicar no GitHub Pages
  publish-results:
    needs: tests
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Robot Framework
        run: |
          python -m pip install --upgrade pip
          pip install robotframework

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: ./all-results

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create consolidated report with rebot
        run: |
          python -m robot.rebot \
          --outputdir ./gh-pages \
          --report index.html \
          --reporttitle "Relatório Consolidado E2E" \
          --name "Robot Framework CI" \
          ./all-results/test-results-*/*.xml
        continue-on-error: true

      - name: Copy browser assets to pages directory
        run: |
          cp -r ./all-results/test-results-*/browser ./gh-pages/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./gh-pages

  # Job para deploy no GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: publish-results
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4